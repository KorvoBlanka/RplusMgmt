% layout 'default';

% use Rplus::Model::Media::Manager;
% use JSON;

% content_for header => begin
<style type="text/css">

</style>
% end

% content_for javascript => begin
<script type="text/javascript">
  "use strict";

  registerGlobalAjaxEvents();

  (function () {
    var $form;

    function listOptions() {

      $.ajax({
        type: "POST",
        url: "/api/options/list",
        data: {
          category: "export",
        },
      })
        .done(function (data, textStatus, jqXHR) {

          $('#formExportAvito [name="company"]:input').val(data.val['avito-company']);
          $('#formExportAvito [name="phone"]:input').val(data.val['avito-phone']);
          $('#formExportAvito [name="agent-phone"]:input').attr('checked', (data.val['avito-agent-phone'] == 'true' || data.val['avito-agent-phone'] == '1') ? true : false);
          $('#formExportAvito [name="email"]:input').val(data.val['avito-email']);

          $('#formExportVnh [name="phones"]:input').val(data.val['vnh-phones']);
          $('#formExportVnh [name="agent-phone"]:input').attr('checked', (data.val['vnh-agent-phone'] == 'true' || data.val['vnh-agent-phone'] == '1') ? true : false);
          $('#formExportVnh [name="company"]:input').val(data.val['vnh-company']);

          $('#formExportFarpost [name="phones"]:input').val(data.val['farpost-phones']);
          $('#formExportFarpost [name="agent-phone"]:input').attr('checked', (data.val['farpost-agent-phone'] == 'true' || data.val['farpost-agent-phone'] == '1') ? true : false);

          $('#formExportPresent [name="phones"]:input').val(data.val['present-phones']);
          $('#formExportPresent [name="agent-phone"]:input').attr('checked', (data.val['present-agent-phone'] == 'true' || data.val['present-agent-phone'] == '1') ? true : false);
          $('#formExportPresent [name="add_description_words"]:input').val(data.val['present-descr']);

          $('#formExportIrr [name="phones"]:input').val(data.val['irr-phones']);
          $('#formExportIrr [name="agent-phone"]:input').attr('checked', (data.val['irr-agent-phone'] == 'true' || data.val['irr-agent-phone'] == '1') ? true : false);
          $('#formExportIrr [name="email"]:input').val(data.val['irr-email']);
          $('#formExportIrr [name="url"]:input').val(data.val['irr-url']);

        }).fail(function (jqXHR, textStatus, errorThrown) {
          alert('<%= loc q{An error occurred while fetching options} %>');
        })
      ;
    }

    function saveOptions(opt_hash) {
      var opts = JSON.stringify(opt_hash);
      $.ajax({
        type: "POST",
        url: "/api/options/set_multiple",
        data: {
          category: "export",
          opt_string: opts, 
        }
      })
        .done(function (data, textStatus, jqXHR) {
          if (data.status == 'success') {

          }
        })
        .fail(function (jqXHR, textStatus, errorThrown) {
          alert('<%= loc q{An error occurred while saving options} %>');
        })
      ;
    }

    $(function () {
      $( ".btn-save" ).click(function(e) {
        
        var t;
        var opt_hash = {};

        t = $('#formExportAvito [name="company"]:input').val();
        opt_hash['avito-company'] = t;

        t = $('#formExportAvito [name="phone"]:input').val();
        opt_hash['avito-phone'] = t;
        
        t = $('#formExportAvito [name="agent-phone"]:input').is(':checked');
        opt_hash['avito-agent-phone'] = t;
        
        t = $('#formExportAvito [name="email"]:input').val();
        opt_hash['avito-email'] = t;


        t = $('#formExportVnh [name="company"]:input').val();
        opt_hash['vnh-company'] = t;

        t = $('#formExportVnh [name="phones"]:input').val();
        opt_hash['vnh-phones'] = t;

        t = $('#formExportVnh [name="agent-phone"]:input').is(':checked');
        opt_hash['vnh-agent-phone'] = t;

        
        t = $('#formExportFarpost [name="phones"]:input').val();
        opt_hash['farpost-phones'] = t;

        t = $('#formExportFarpost [name="agent-phone"]:input').is(':checked');
        opt_hash['farpost-agent-phone'] = t;


        t = $('#formExportPresent [name="add_description_words"]:input').val();
        opt_hash['present-descr'] = t;

        t = $('#formExportPresent [name="agent-phone"]:input').is(':checked');
        opt_hash['present-agent-phone'] = t;

        t = $('#formExportPresent [name="phones"]:input').val();
        opt_hash['present-phones'] = t;


        t = $('#formExportIrr [name="phones"]:input').val();
        opt_hash['irr-phones'] = t;
        
        t = $('#formExportIrr [name="agent-phone"]:input').is(':checked');
        opt_hash['irr-agent-phone'] = t;

        t = $('#formExportIrr [name="email"]:input').val();
        opt_hash['irr-email'] = t;
        
        t = $('#formExportIrr [name="url"]:input').val();
        opt_hash['irr-url'] = t;

        saveOptions(opt_hash);
      });
      
      listOptions();   
    });
  })();

  (function () {
    var $modal, $form;


  })();
</script>
% end

% content_for modals => begin


% end

<div class="row">
  <h3 class="page-header">Экспорт</h3>
  <ul class="nav nav-tabs">
    % my $loc_id = $self->session('user')->{location_id};      # костыль!
    % if ($loc_id == 1) {
    <li class="active"><a href="#export-avito" data-toggle="tab">Avito</a></li>
    <li><a href="#export-irr" data-toggle="tab">Из рук в руки</a></li>
    <li><a href="#export-farpost" data-toggle="tab">Farpost</a></li>
    <li><a href="#export-present" data-toggle="tab">Презент</a></li>
    <li><a href="#export-vnh" data-toggle="tab">ВНХ</a></li>
    % } else {
    <li class="active"><a href="#export-avito" data-toggle="tab">Avito</a></li>
    <li><a href="#export-irr" data-toggle="tab">Из рук в руки</a></li>
    <li><a href="#export-farpost" data-toggle="tab">Farpost</a></li>
    <li class="hidden"><a href="#export-vnh" data-toggle="tab">ВНХ</a></li>
    <li class="hidden"><a href="#export-present" data-toggle="tab">Презент</a></li>
    % }
  </ul>  
</div>

  <!-- Tab panes -->
  <div class="tab-content">

    <div class="tab-pane active" id="export-avito">
      <form class="" role="form" id="formExportAvito">
        <div class="row" style="padding-top: 15px;">
          <label class="col-lg-2 control-label">Название компании</label>
          <div class="col-lg-5">
            <input type="text" class="form-control" name="company" placeholder="Название компании">
          </div>
        </div>      
        <div class="row" style="padding-top: 15px;">
          <label class="col-lg-2 control-label">Контактный телефон</label>
          <div class="col-lg-5">
            <input type="text" class="form-control" name="phone" placeholder="телефон">
          </div>
        </div>
        <div class="row" style="padding-top: 15px;">
          <label class="col-lg-2 control-label">Телефон агента</label>
          <div class="col-lg-5">
            <input type="checkbox" name="agent-phone">
          </div>
        </div>        
        <div class="row" style="padding-top: 15px;">
          <label class="col-lg-2 control-label">e-mail</label>
          <div class="col-lg-5">
            <input type="text" class="form-control" name="email" placeholder="somemail@mail.com">
          </div>
        </div>
      </form>
      <div class="form-group">
        <button type="" class="btn btn-primary btn-save" style="margin-top: 15px">Сохранить</button>
      </div>
    </div>

    <div class="tab-pane" id="export-irr">
      <form class="" role="form" id="formExportIrr">
        <div class="row" style="padding-top: 15px;">
          <label class="col-lg-2 control-label">Телефоны</label>
          <div class="col-lg-5">
            <input type="text" class="form-control" name="phones" placeholder="Phone1, Phone2">
          </div>
        </div>
        <div class="row" style="padding-top: 15px;">
          <label class="col-lg-2 control-label">Телефон агента</label>
          <div class="col-lg-5">
            <input type="checkbox" name="agent-phone">
          </div>
        </div>
        <div class="row" style="padding-top: 15px;">
          <label class="col-lg-2 control-label">e-mail</label>
          <div class="col-lg-5">
            <input type="text" class="form-control" name="email" placeholder="somemail@mail.com">
          </div>
        </div>
        <div class="row" style="padding-top: 15px;">
          <label class="col-lg-2 control-label">Адрес сайта</label>
          <div class="col-lg-5">
            <input type="text" class="form-control" name="url" placeholder="mysiteurl.com">
          </div>
        </div>
      </form>
      <div class="form-group">
        <button type="" class="btn btn-primary btn-save" style="margin-top: 15px">Сохранить</button>
      </div>
    </div>

    <div class="tab-pane" id="export-farpost">
      <div class="row" style="padding-top: 15px;">
        <p>Нет настраиваемых параметров</p>
      </div>
      <form class="hidden" role="form" id="formExportFarpost">
        <div class="row" style="padding-top: 15px;">
          <label class="col-lg-2 control-label">Телефоны</label>
          <div class="col-lg-5">
            <input type="text" class="form-control" name="phones" placeholder="Phone1, Phone2">
          </div>
        </div>
        <div class="row" style="padding-top: 15px;">
          <label class="col-lg-2 control-label">Телефон агента</label>
          <div class="col-lg-5">
            <input type="checkbox" name="agent-phone">
          </div>
        </div>
      </form>
      <div class="form-group">
        <button type="" class="btn btn-primary btn-save" style="margin-top: 64px">Сохранить</button>
      </div>
    </div>

    <div class="tab-pane" id="export-vnh">
      <form class="" role="form" id="formExportVnh">
        <div class="row" style="padding-top: 15px;">
          <label class="col-lg-2 control-label">Название компании</label>
          <div class="col-lg-5">
            <input type="text" class="form-control" name="company" placeholder="Company">
          </div>
        </div>      
        <div class="row" style="padding-top: 15px;">
          <label class="col-lg-2 control-label">Телефоны</label>
          <div class="col-lg-5">
            <input type="text" class="form-control" name="phones" placeholder="Phone1, Phone2">
          </div>
        </div>
        <div class="row" style="padding-top: 15px;">
          <label class="col-lg-2 control-label">Телефон агента</label>
          <div class="col-lg-5">
            <input type="checkbox" name="agent-phone">
          </div>
        </div>
      </form>
      <div class="form-group">
        <button type="" class="btn btn-primary btn-save" style="margin-top: 15px">Сохранить</button>
      </div>
    </div>

    <div class="tab-pane" id="export-present">
      <form class="" role="form" id="formExportPresent">
        <div class="row" style="padding-top: 15px;">
          <label class="col-lg-2 control-label">Телефоны</label>
          <div class="col-lg-5">
            <input type="text" class="form-control" name="phones" placeholder="Phone1, Phone2">
          </div>
        </div>
        <div class="row" style="padding-top: 15px;">
          <label class="col-lg-2 control-label">Телефон агента</label>
          <div class="col-lg-5">
            <input type="checkbox" name="agent-phone">
          </div>
        </div>
        <div class="row" style="padding-top: 15px;">
          <label class="col-lg-2 control-label">Количество слов в описании</label>
          <div class="col-lg-5">
            <input type="number" class="form-control" name="add_description_words" style="width: 100px;" placeholder="# of words">
          </div>
        </div>          
      </form>
      <div class="form-group">
        <button type="" class="btn btn-primary btn-save" style="margin-top: 15px">Сохранить</button>
      </div>
    </div>

  </div>

<nav class="navbar navbar-default navbar-fixed-bottom">
  <div class="container">
    <p class="navbar-text navbar-right"><span class="glyphicon glyphicon-refresh animation-rotate invisible indicator-ajax"></span></p>
  </div>
</nav>
