<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title><%= &title || 'RplusMgmt' %></title>
    <!--meta name="viewport" content="width=device-width, initial-scale=1.0"-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Rplus Management">
    <meta name="author" content="Alexander Borisenko">

    <meta name = "description" content = "" />
    <meta name = "keywords" content = "" />
    <meta name = "robots" content = "noindex,nofollow" />

    <!-- Bootstrap -->
    <link rel="stylesheet" href="<%= $assets_url %>/bootstrap/<%= $bootstrap_ver %>/css/bootstrap.min.css">
    <!-- Pines Notify -->
    <link rel="stylesheet" href="<%= $assets_url %>/pnotify/1.2.2/jquery.pnotify.default.css">
    <!-- <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet"> -->

    <style type="text/css">
      body {
        padding-top: 70px;
        padding-bottom: 50px;
      }
  
      .margin-bottom-10 {
        margin-bottom: 10px;
      }

      .margin-bottom-15 {
        margin-bottom: 15px;
      }

      .margin-bottom-20 {
        margin-bottom: 20px;
      }

      textarea {
        max-width: 100%;
      }

      .list-group.list-compact > .list-group-item {
        padding-top: 5px ;
        padding-bottom: 5px;
        border-left: 0;
        border-right: 0;
        border-radius: 0;
      }

      .list-group.list-compact > .list-group-item:first-of-type {
        border-top: 0;
      }

      .list-group.list-compact > .list-group-item:last-of-type {
        border-bottom: 0;
      }

      .well-md {
        padding: 15px;
        margin-bottom: 15px;
      }

      .panel-md {
        margin-bottom: 15px;
      }

      .panel-sm {
        margin-bottom: 15px;
      }

      .panel-sm .panel-body {
        padding: 9px;
      }

      .form-group-sm {
        margin-bottom: 10px;
      }

      .nav-sm > li > a {
        padding: 8px 12px;
      }

      .hr-sm {
        margin-top: 10px;
        margin-bottom: 10px;
      }

      % if ($self->req->headers->user_agent =~ /Windows/) {
        ::-webkit-scrollbar {
          width: 5px;
        }

        ::-webkit-scrollbar-track {
          margin: 2px;
          /* set the style/colour of the scroll bar background */
          background:
          -webkit-gradient(
            linear,
            0 0,
            100% 0,
            from(rgba(0,0,0,0.2)),
            to(rgba(0,0,0,0.12))
          );
          -webkit-box-shadow: 0 1px 0 0 rgba(255,255,255,0.35);
          -webkit-border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
          /* this is the acutal scrooll bar, set the colours here to match your site */
          /* I have used grey's (#464646 & #383838 & #cccccc) */
          background: rgba(0,0,0,.5);
          -webkit-border-radius: 6px;
          -webkit-background-clip: padding-box;
        }
      % }

      .animation-rotate {
        -webkit-animation: spin 2s infinite linear;
                animation: spin 2s infinite linear;
      }

      @-webkit-keyframes spin {
        0% {
          -webkit-transform: rotate(0deg);
        }
        100% {
          -webkit-transform: rotate(359deg);
        }
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(359deg);
        }
      }

      .geo-map {
        cursor: default !important;
      }

      .geo-map:active {
        cursor: -webkit-grab !important;
      }

      .disable-on-ajax.disabled {
        /*opacity: 0.5;*/
        pointer-events: none;
      }

      .ui-pnotify.stack-bottomright {
        /* These are just CSS default values to reset the pnotify CSS. */
        right: auto;
        top: auto;
      }

      .help-window {
        position: absolute; 
        top: 50%; 
        left: 50%; 
        height: 600px; 
        width: 800px; 
        margin-top: -300px; 
        margin-left: -400px; 
        z-index: 9000;

        background-color: #eee;
      }

      .navbar-inverse {
        /*background-color: #001F3C;*/
        background-color: #062141;
        border-color: #003242;
      }

      .navbar-inverse .navbar-nav > .active > a, .navbar-inverse .navbar-nav > .active > a:hover {
        background-color: #00305E;
      }

      .navbar-inverse .navbar-nav > .open > a, .navbar-inverse .navbar-nav > .open > a:hover, .navbar-inverse .navbar-nav > .open > a:focus {
        background-color: #00305E; 
      }

      .navbar-inverse .navbar-nav > li > a {
        color: #ddd;
      }

      .navbar-inverse .navbar-brand {
        color: #929292;
      }

      .quick-notifier {
        position: absolute;
        top: 2px;
        right: 2px;
        background-color: rgb(255, 41, 0);
        z-index: 1;
        font-weight: 400;
      }

      .modal-header {
        background-color: #eaeaea;
      }
      
      .modal-content {
        border-radius: 0px;
      }

      .modal-body {
        overflow-y: scroll;
        overflow-x: hidden;
        -webkit-overflow-scrolling: touch;
        
        padding: 15px;
        border-radius: 0px;
      }

    </style>

    <%= content_for 'header' %>
  </head>
  <body>

  <div class="help-window hidden">
  </div>

  <div class="indicator-ajax invisible" style="position: absolute; top: 50%; left: 50%; margin-top: -20px; margin-left: -20px; z-index: 1000;">
    <div style="background-color: #fff; border-radius: 50%;">
      <img style="width: 40px;" src="<%= $assets_url%>/loading-blue.gif">
    </div>
  </div>
    <!-- Navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-top-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a href="/" class="navbar-brand">RplusMgmt</a>
        </div>

        <div class="collapse navbar-collapse navbar-top-collapse">
          <ul class="nav navbar-nav">
          % if (!is_hidden_nav('planner')) {
            <li class="<%= $controller eq 'planner' && 'active' %>"><span id="task-count-notifier" class="badge badge-default quick-notifier hidden"></span><a href="/planner"><span class="glyphicon glyphicon-list-alt"></span> Ежедневник</a></li>
          % }          
          % if (has_permission(realty => 'read') && !is_hidden_nav('search')) {
            <li class="<%= $controller eq 'search' && 'active' %>"><a href="/search"><span class="glyphicon glyphicon-earphone"></span> Call-центр</a></li>
          % }
          % if (has_permission(realty => 'read') && !is_hidden_nav('realty')) {
            <li class="<%= $controller eq 'realty' && 'active' %>"><a href="/realty"><span class="glyphicon glyphicon-home"></span> <%= ucfloc q{realty} %></a></li>
          % }
          % if (has_permission(clients => 'read') && !is_hidden_nav('clients')) {
            <li class="<%= $controller eq 'clients' && 'active' %>"><span id="client-count-notifier" class="badge badge-default quick-notifier hidden"></span><a href="/clients"><span class="glyphicon glyphicon-user"></span> Спрос</a></li>
          % }
          % if (has_permission(realty => 'export') || has_permission(realty => 'analyse')) {
            <li class="dropdown <%= $controller eq 'service' && 'active' %>">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown"><span class="glyphicon glyphicon-star"></span> <%= ucfloc q{services} %> <b class="caret"></b></a>
              <ul class="dropdown-menu">
              % if (has_permission(realty => 'export')) {
                <li><a href="/service/export"><span class="glyphicon glyphicon-export"></span> <%= ucfloc q{advertisement} %></a></li>
              % }
              % if(has_permission(realty => 'analyse')) {
                <li><a href="/service/analytics"><span class="glyphicon glyphicon-list-alt"></span> <%= ucfloc q{analytics} %></a></li>
              % }
              % if(has_permission(realty => 'analyse')) {
                <li><a href="/service/piramid"><span class="glyphicon glyphicon-list-alt"></span> Воронка</a></li>
              % }              
              </ul>
            </li>
          % }
          % if (
          %  has_permission(mediators => 'read') || has_permission(landmarks => 'read') || has_permission(users => 'manage')
          % ) {
            <li class="dropdown <%= $controller eq 'configuration' && 'active' %>">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown"><span class="glyphicon glyphicon-cog"></span> <b class="caret"></b></a>
              <ul class="dropdown-menu">
              % if (has_permission(mediators => 'read')) {
                <li><a href="/configuration/mediators"><span class="glyphicon glyphicon-ban-circle"></span> <%= ucfloc q{mediators} %></a></li>
              % }
              % if (has_permission(landmarks => 'read')) {
                <li><a href="/configuration/landmarks"><span class="glyphicon glyphicon-globe"></span> <%= ucfloc q{landmarks} %></a></li>
              % }
              % if (has_permission(users => 'manage')) {
                <li><a href="/configuration/users"><span class="glyphicon glyphicon-user"></span> <%= ucfloc q{users} %></a></li>
              % }
              % if (has_permission(realty=> 'export')) {
                <li><a href="/configuration/import"><span class="glyphicon glyphicon-import"></span> <%= ucfloc q{objects import} %></a></li>
                <li><a href="/configuration/export"><span class="glyphicon glyphicon-export"></span> <%= ucfloc q{advertisement} %></a></li>
                <li><a href="/configuration/notifications"><span class="glyphicon glyphicon-send"></span> <%= ucfloc q{notifications} %></a></li>
              % }
                <li><a href="/configuration/tasks"><span class="glyphicon glyphicon-list-alt"></span> Задачи</a></li>
              </ul>
            </li>
          % }
          </ul>
          <p class="navbar-text navbar-right">
            [<a href="/signout" class="navbar-link"><%= $user->{'name'} %></a>]
          </p>
        </div>
      </div>
    </nav>

    <div class="container disable-on-ajax disable-on-context">
      <%= content %>

      <!-- Modal Definitions -->
      <%= content_for 'modals' %>
    </div>

    <!-- JavaScript -->
    <script type="application/javascript" src="<%= $assets_url %>/jquery/<%= $jquery_ver %>/jquery-<%= $jquery_ver %>.min.js"></script>
    <%= content_for 'before_bootstrap' %>
    <!-- Bootstrap -->
    <script type="application/javascript" src="<%= $assets_url %>/bootstrap/<%= $bootstrap_ver %>/js/bootstrap.min.js"></script>
    <!-- MomentJS -->
    <script type="application/javascript" src="<%= $assets_url %>/moment/<%= $momentjs_ver %>/moment-with-locales.min.js"></script>
    <!-- HolderJS -->
    <script type="application/javascript" src="<%= $assets_url %>/holder/<%= $holderjs_ver %>/holder.min.js"></script>
    <script> 
      Holder.add_theme("big", {background:"#eee", foreground:"#a3cd73", size: 52});
    </script>
    <!-- Pines Notify -->
    <script type="application/javascript" src="<%= $assets_url %>/pnotify/1.2.2/jquery.pnotify.js"></script>
    <%= content_for 'after_bootstrap' %>

    <%= include 'javascript/rplus' %>
    <%= include 'javascript/rplus_table' %>
    <%= include 'javascript/rplus_realty' %>

    <script type="application/javascript">
      "use strict";

      moment.locale('ru');
      moment._months = [
              "Января", "Февраля", "Марта", "Апреля", "Мая", "Июня", "Июля",
              "Августа", "Сентября", "Октября", "Ноября", "Декабря",
          ];

      var globalAjaxEventsRegistered = 0;
      var show_ajax_indicator = 1;

      function registerGlobalAjaxEvents() {
        if (globalAjaxEventsRegistered) return;
        $(document)
          .ajaxStart(function () {
            if (show_ajax_indicator == 1) {
              $('.disable-on-ajax').addClass('disabled'); 
              $('.indicator-ajax').removeClass('invisible');
            }
          })
          .ajaxStop(function () {
            $('.disable-on-ajax').removeClass('disabled'); 
            $('.indicator-ajax').addClass('invisible');
          })
        ;
        globalAjaxEventsRegistered = 1;
      }

      function supressAjaxIndicator(supress) {
        if (supress == 1) {
          show_ajax_indicator = 0;
        } else {
          show_ajax_indicator = 1;
        }
      }
    </script>
    <%= content_for 'javascript' %>

    <script type="application/javascript">
      "use strict";
      $(function () {
        $(document).on('click', 'a[href="#"]', function (event) { event.preventDefault(); });
        $(window).on('load', function (event) { 
          var browser = /chrome/.test(navigator.userAgent.toLowerCase()) || /safari/.test(navigator.userAgent.toLowerCase());
          if (!browser) {
            alert('Для корректной работы программы необходимо использовать браузер Google Chrome');
          }
        });
        
      });

      function getClientNewCount() {
        supressAjaxIndicator(1);
        $.ajax({
          type: "POST",
          url: "/api/client/get_count",
          data: {offer_type_code: Rplus.Variables['User'].offer_mode},
          complete: function () {}
        })
          .done(function (data, textStatus, jqXHR) {
            if (data.status == 'success') {
              if (data.clients_count == 0) {              
                $('#client-count-notifier').addClass('hidden');
              } else {
                $('#client-count-notifier').html(data.clients_count);
                $('#client-count-notifier').removeClass('hidden');
              }
            }
          });
        supressAjaxIndicator(0);
      }

      function getTodaysTasksCount () {
        supressAjaxIndicator(1);
        var start_date = moment().startOf('day').format();
        var end_date = moment().startOf('day').add(1, 'days').format();
        $.ajax({
          type: "POST",
          url: "/api/task/get_task_count",
          data: {
            agent_id: <%= $self->stash('user')->{id} %>,
            task_status: 'new',
            start_date: start_date,
            end_date: end_date,
          },
          complete: function () {}
        })
          .done(function (data, textStatus, jqXHR) {
            if (data.status == 'success') {
              if (data.count == 0) {              
                $('#task-count-notifier').addClass('hidden');
              } else {
                $('#task-count-notifier').html(data.count);
                $('#task-count-notifier').removeClass('hidden');
              }
            }
          });
        supressAjaxIndicator(0);        
      }

      getTodaysTasksCount();
      setInterval(getTodaysTasksCount, 30000);

      setTimeout(getClientNewCount, 3000);
      setInterval(getClientNewCount, 60000);

      window.Rplus.Functions = { 
        getTodaysTasksCount: function () {
          getTodaysTasksCount();
        },
        getClientNewCount: function () {
          getClientNewCount();
        }        
      };
    </script>
  </body>
</html>
