#!/usr/bin/env perl

use FindBin;
use lib "$FindBin::Bin/../../lib";

use Rplus::Modern;

use Rplus::Model::Realty;
use Rplus::Model::Realty::Manager;
use Rplus::Model::Mediator;
use Rplus::Model::Mediator::Manager;
use Rplus::Model::MediatorCompany;
use Rplus::Model::MediatorCompany::Manager;

use Rplus::Util::Config qw(get_config);
use Rplus::Util::Mediator qw(delete_mediator add_mediator);

use Mojo::UserAgent;
use List::Flatten;

use JSON;
use Data::Dumper;

my $obs_period = 30;
# синхронизация базы посредниклв клиента и буффера

run(get_config());

sub run {
    my $config = shift;

    # Загрузим базу телефонов посредников
    my %MEDIATOR_PHONES;
    {
        my $mediator_iter = Rplus::Model::Mediator::Manager->get_objects_iterator(query => [delete_date => undef], require_objects => ['company']);
        while (my $x = $mediator_iter->next) {
            $MEDIATOR_PHONES{$x->phone_num} = {
                id => $x->id,
                name => $x->name,
                company => $x->company->name,
                company_id => $x->company->id,
            };
        }
    }

    my $ua = Mojo::UserAgent->new;    

    my $tx = $ua->get('http://rplusmgmt.com/api/account/get_by_domain?subdomain=' . $config->{'subdomain'});
    my $acc_data;
    if (my $res = $tx->success) {
      $acc_data = $res->json;
    }

    my $rt_param = Rplus::Model::RuntimeParam->new(key => 'sync_param')->load();
    if (!$rt_param) {
        $rt_param = Rplus::Model::RuntimeParam->new(key => 'sync_param', ts => 'now()')->save; # Create record
    }
    my $last_ts = $rt_param->ts;

    #if ($acc_data->{use_mediators_buffer}) {
        my $tx = $ua->get($acc_data->{realty_buffer_url} . '/api/mediator/list_mediators_ex', form => {mode => 'new', ts => $ts});
        if (my $res = $tx->success) {
            my $med_list = $res->json->{list};
            for my $mediator (@$med_list) {
                add_mediator($mediator->{company_name}, $mediator->{phone_num}, 'buffer');
            }
        }
    #}

    $rt_param->ts('now');
    $rt_param->save(chages_only => 1);
}

1;
